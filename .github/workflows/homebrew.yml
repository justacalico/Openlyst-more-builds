name: Build Homebrew Tap

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for (macOS or Linux)'
        required: false
        default: 'both'
        type: choice
        options:
          - macOS
          - Linux
          - both

permissions:
  contents: write

concurrency:
  group: "homebrew-tap"
  cancel-in-progress: false

jobs:
  build-macos:
    if: ${{ github.event.inputs.platform == 'macOS' || github.event.inputs.platform == 'both' || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Homebrew tap for macOS
        run: |
          python build_homebrew_tap.py \
            --output-dir homebrew-tap \
            --platform macOS \
            --calculate-sha256 \
            --verbose
      
      - name: Display macOS build output
        run: |
          echo "=== Homebrew Tap Structure ==="
          find homebrew-tap -type f -name "*.rb" | head -10
          echo ""
          echo "=== Generated Formulae Count ==="
          find homebrew-tap/Formula -name "*.rb" | wc -l
          echo ""
          echo "=== Sample Formula ==="
          find homebrew-tap/Formula -name "*.rb" | head -1 | xargs cat || echo "No formulae generated"
      
      - name: Upload macOS formulae as artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-tap-macos
          path: homebrew-tap/
  
  build-linux:
    if: ${{ github.event.inputs.platform == 'Linux' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Homebrew tap for Linux
        run: |
          python build_homebrew_tap.py \
            --output-dir homebrew-tap-linux \
            --platform Linux \
            --calculate-sha256 \
            --verbose
      
      - name: Display Linux build output
        run: |
          echo "=== Homebrew Tap Structure ==="
          find homebrew-tap-linux -type f -name "*.rb" | head -10
          echo ""
          echo "=== Generated Formulae Count ==="
          find homebrew-tap-linux/Formula -name "*.rb" | wc -l
          echo ""
          echo "=== Sample Formula ==="
          find homebrew-tap-linux/Formula -name "*.rb" | head -1 | xargs cat || echo "No formulae generated"
      
      - name: Upload Linux formulae as artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-tap-linux
          path: homebrew-tap-linux/
  
  commit-changes:
    needs: [build-macos, build-linux]
    if: always() && (needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download macOS artifacts
        if: ${{ needs.build-macos.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: homebrew-tap-macos
          path: homebrew-tap/
      
      - name: Download Linux artifacts  
        if: ${{ needs.build-linux.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: homebrew-tap-linux
          path: homebrew-tap-linux/
      
      - name: Merge formulae if both platforms built
        if: ${{ needs.build-macos.result == 'success' && needs.build-linux.result == 'success' }}
        run: |
          # Copy Linux formulae to main tap directory with -linux suffix if conflicts
          for formula in homebrew-tap-linux/Formula/*.rb; do
            if [ -f "$formula" ]; then
              basename_formula=$(basename "$formula")
              if [ -f "homebrew-tap/Formula/$basename_formula" ]; then
                # Conflict - rename Linux version
                linux_name="${basename_formula%.rb}-linux.rb"
                cp "$formula" "homebrew-tap/Formula/$linux_name"
              else
                cp "$formula" "homebrew-tap/Formula/"
              fi
            fi
          done
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push changes
        run: |
          git add homebrew-tap/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Homebrew formulae $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            # Try to push, if it fails due to conflicts, pull and retry
            if ! git push; then
              echo "Push failed, pulling latest changes and retrying..."
              git pull origin main --rebase
              git push
            fi
          fi