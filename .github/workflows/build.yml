name: Manual Multi-Platform Build
on:
  workflow_dispatch:
    inputs:
      build_doudou:
        description: 'Build Doudou'
        required: false
        type: boolean
        default: false
      doudou_commit_hash:
        description: 'Doudou commit hash (leave empty for latest)'
        required: false
        type: string
        default: ''
      build_docan:
        description: 'Build Docan'
        required: false
        type: boolean
        default: false
      docan_commit_hash:
        description: 'Docan commit hash (leave empty for latest)'
        required: false
        type: string
        default: ''
      build_finar:
        description: 'Build Finar'
        required: false
        type: boolean
        default: false
      finar_commit_hash:
        description: 'Finar commit hash (leave empty for latest)'
        required: false
        type: string
        default: ''
      build_klit:
        description: 'Build Klit'
        required: false
        type: boolean
        default: false
      klit_commit_hash:
        description: 'Klit commit hash (leave empty for latest)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

env:
  FLUTTER_VERSION: 'stable'

jobs:
  # ============================================================================
  # WINDOWS BUILDS
  # ============================================================================
  
  # 1. BUILD WINDOWS - DOUDOU (x64)
  build-windows-doudou:
    if: ${{ github.event.inputs.build_doudou == 'true' }}
    runs-on: windows-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
      warnings: ${{ steps.status.outputs.warnings }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(Get-Date -Format 'o')" >> $env:GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/doudou.git . 

      - name: Checkout specific commit
        if: ${{ github.event.inputs.doudou_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.doudou_commit_hash }}

      - name: Get version and date
        id: version
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern '^version:').Line -replace 'version: ', '' -replace '\+.*', ''
          $date = Get-Date -Format 'yyyy-MM-dd'
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build_date=$date" >> $env:GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Build Windows
        id: build
        run: |
          flutter pub get 2>&1 | Tee-Object -Variable pubgetOutput
          flutter build windows --release 2>&1 | Tee-Object -Variable buildOutput
          $warnings = ($buildOutput | Select-String -Pattern "warning|deprecated" -AllMatches).Matches.Count
          echo "warnings=$warnings" >> $env:GITHUB_OUTPUT
      
      - name: ZIP Windows Build
        run: |
          $filename = "doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-windows-x64.zip"
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $filename

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          $start = [DateTime]::Parse("${{ steps.start.outputs.start_time }}")
          $duration = [Math]::Round(((Get-Date) - $start).TotalMinutes, 1)
          echo "duration=$duration" >> $env:GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: |
          echo "status=${{ job.status }}" >> $env:GITHUB_OUTPUT
          echo "warnings=${{ steps.build.outputs.warnings }}" >> $env:GITHUB_OUTPUT

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: doudou-windows-x64
          path: doudou-*-windows-x64.zip

  # 2. BUILD WINDOWS - DOCAN (x64)
  build-windows-docan:
    if: ${{ github.event.inputs.build_docan == 'true' }}
    runs-on: windows-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(Get-Date -Format 'o')" >> $env:GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/docan.git . 

      - name: Checkout specific commit
        if: ${{ github.event.inputs.docan_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.docan_commit_hash }}

      - name: Get version and date
        id: version
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern '^version:').Line -replace 'version: ', '' -replace '\+.*', ''
          $date = Get-Date -Format 'yyyy-MM-dd'
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build_date=$date" >> $env:GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Build Windows
        run: |
          flutter pub get
          flutter build windows --release
      
      - name: ZIP Windows Build
        run: |
          $filename = "docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-windows-x64.zip"
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $filename

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          $start = [DateTime]::Parse("${{ steps.start.outputs.start_time }}")
          $duration = [Math]::Round(((Get-Date) - $start).TotalMinutes, 1)
          echo "duration=$duration" >> $env:GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $env:GITHUB_OUTPUT

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docan-windows-x64
          path: docan-*-windows-x64.zip

  # 3. BUILD WINDOWS - FINAR (x64)
  build-windows-finar:
    if: ${{ github.event.inputs.build_finar == 'true' }}
    runs-on: windows-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(Get-Date -Format 'o')" >> $env:GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/finar.git . 

      - name: Checkout specific commit
        if: ${{ github.event.inputs.finar_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.finar_commit_hash }}

      - name: Get version and date
        id: version
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern '^version:').Line -replace 'version: ', '' -replace '\+.*', ''
          $date = Get-Date -Format 'yyyy-MM-dd'
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build_date=$date" >> $env:GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Build Windows
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          flutter build windows --release
      
      - name: ZIP Windows Build
        run: |
          $filename = "finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-windows-x64.zip"
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $filename

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          $start = [DateTime]::Parse("${{ steps.start.outputs.start_time }}")
          $duration = [Math]::Round(((Get-Date) - $start).TotalMinutes, 1)
          echo "duration=$duration" >> $env:GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $env:GITHUB_OUTPUT

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finar-windows-x64
          path: finar-*-windows-x64.zip

  # 4. BUILD WINDOWS - KLIT (x64)
  build-windows-klit:
    if: ${{ github.event.inputs.build_klit == 'true' }}
    runs-on: windows-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(Get-Date -Format 'o')" >> $env:GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/klit.git . 

      - name: Checkout specific commit
        if: ${{ github.event.inputs.klit_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.klit_commit_hash }}

      - name: Get version and date
        id: version
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern '^version:').Line -replace 'version: ', '' -replace '\+.*', ''
          $date = Get-Date -Format 'yyyy-MM-dd'
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build_date=$date" >> $env:GITHUB_OUTPUT

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Build Windows
        run: |
          flutter pub get
          flutter build windows --release
      
      - name: ZIP Windows Build
        run: |
          $filename = "klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-windows-x64.zip"
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $filename

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          $start = [DateTime]::Parse("${{ steps.start.outputs.start_time }}")
          $duration = [Math]::Round(((Get-Date) - $start).TotalMinutes, 1)
          echo "duration=$duration" >> $env:GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $env:GITHUB_OUTPUT

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: klit-windows-x64
          path: klit-*-windows-x64.zip

  # ============================================================================
  # ANDROID BUILDS (APK + AAB)
  # ============================================================================

  # ANDROID - DOUDOU
  build-android-doudou:
    if: ${{ github.event.inputs.build_doudou == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
      signing: ${{ steps.signing.outputs.signing }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/doudou.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.doudou_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.doudou_commit_hash }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android signing
        id: signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.DOUDOU_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.DOUDOU_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.DOUDOU_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.DOUDOU_KEY_ALIAS }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "Setting up release signing..."
            mkdir -p android/keystore
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore/upload-keystore.jks
            cat > android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=keystore/upload-keystore.jks
          EOF
            echo "signing=release" >> $GITHUB_OUTPUT
          else
            echo "signing=debug" >> $GITHUB_OUTPUT
            echo "⚠️ No keystore configured, using debug signing"
          fi

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_NUMBER=$(date +%s | cut -c4-10)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/flutter-apk/app-release.apk doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.apk

      - name: Build AAB
        run: |
          flutter build appbundle --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/bundle/release/app-release.aab doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.aab

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doudou-android
          path: |
            doudou-*.apk
            doudou-*.aab

  # ANDROID - DOCAN
  build-android-docan:
    if: ${{ github.event.inputs.build_docan == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
      signing: ${{ steps.signing.outputs.signing }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/docan.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.docan_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.docan_commit_hash }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android signing
        id: signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.DOCAN_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.DOCAN_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.DOCAN_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.DOCAN_KEY_ALIAS }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "Setting up release signing..."
            mkdir -p android/keystore
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore/upload-keystore.jks
            cat > android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=keystore/upload-keystore.jks
          EOF
            echo "signing=release" >> $GITHUB_OUTPUT
          else
            echo "signing=debug" >> $GITHUB_OUTPUT
            echo "⚠️ No keystore configured, using debug signing"
          fi

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_NUMBER=$(date +%s | cut -c4-10)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/flutter-apk/app-release.apk docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.apk

      - name: Build AAB
        run: |
          flutter build appbundle --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/bundle/release/app-release.aab docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.aab

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docan-android
          path: |
            docan-*.apk
            docan-*.aab

  # ANDROID - FINAR
  build-android-finar:
    if: ${{ github.event.inputs.build_finar == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
      signing: ${{ steps.signing.outputs.signing }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/finar.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.finar_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.finar_commit_hash }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android signing
        id: signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.FINAR_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.FINAR_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.FINAR_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.FINAR_KEY_ALIAS }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "Setting up release signing..."
            mkdir -p android/app/keystore
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/keystore/upload-keystore.jks
            cat > android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=keystore/upload-keystore.jks
          EOF
            echo "signing=release" >> $GITHUB_OUTPUT
          else
            echo "signing=debug" >> $GITHUB_OUTPUT
            echo "⚠️ No keystore configured, using debug signing"
          fi

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_NUMBER=$(date +%s | cut -c4-10)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build APK
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          flutter build apk --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/flutter-apk/app-release.apk finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.apk

      - name: Build AAB
        run: |
          flutter build appbundle --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/bundle/release/app-release.aab finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.aab

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: finar-android
          path: |
            finar-*.apk
            finar-*.aab

  # ANDROID - KLIT
  build-android-klit:
    if: ${{ github.event.inputs.build_klit == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
      signing: ${{ steps.signing.outputs.signing }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/klit.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.klit_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.klit_commit_hash }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android signing
        id: signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.KLIT_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KLIT_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.KLIT_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.KLIT_KEY_ALIAS }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "Setting up release signing..."
            mkdir -p android/keystore
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore/upload-keystore.jks
            cat > android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=../keystore/upload-keystore.jks
          EOF
            echo "signing=release" >> $GITHUB_OUTPUT
          else
            echo "signing=debug" >> $GITHUB_OUTPUT
            echo "⚠️ No keystore configured, using debug signing"
          fi

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_NUMBER=$(date +%s | cut -c4-10)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/flutter-apk/app-release.apk klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.apk

      - name: Build AAB
        run: |
          flutter build appbundle --release --build-name=${{ steps.version.outputs.version }} --build-number=${{ steps.version.outputs.build_number }}
          mv build/app/outputs/bundle/release/app-release.aab klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}.aab

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: klit-android
          path: |
            klit-*.apk
            klit-*.aab

  # ============================================================================
  # LINUX BUILDS (ZIP, AppImage, DEB)
  # ============================================================================

  # LINUX - DOUDOU
  build-linux-doudou:
    if: ${{ github.event.inputs.build_doudou == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/doudou.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.doudou_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.doudou_commit_hash }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libmpv-dev dpkg-dev wget file squashfs-tools patchelf plocate libfuse2
          # Update locate database
          sudo updatedb || true

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install appimagetool
        run: |
          wget -q -O /tmp/appimagetool.AppImage "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool.AppImage
          cd /tmp && ./appimagetool.AppImage --appimage-extract
          sudo mv /tmp/squashfs-root /opt/appimagetool
          sudo ln -sf /opt/appimagetool/AppRun /usr/local/bin/appimagetool
          # Verify appimagetool works
          appimagetool --version || echo "appimagetool installed"

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build/linux/x64/release
          zip -r $GITHUB_WORKSPACE/doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x64.zip bundle/

      - name: Install fastforge and build packages
        run: |
          dart pub global activate fastforge
          export PATH="$PATH:$HOME/.pub-cache/bin"
          export PUB_CACHE="$HOME/.pub-cache"
          mkdir -p artifacts
          
          # Check for configuration files
          echo "=== Checking configuration files ==="
          ls -la linux/packaging/ || echo "No linux/packaging directory"
          ls -la linux/packaging/deb/ 2>/dev/null || echo "No deb config"
          ls -la linux/packaging/appimage/ 2>/dev/null || echo "No appimage config"
          cat distribute_options.yaml 2>/dev/null || echo "No distribute_options.yaml"
          
          # Build DEB
          echo "=== Building DEB package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets deb --skip-clean || echo "DEB build failed or had warnings"
          
          # Build AppImage
          echo "=== Building AppImage package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets appimage --skip-clean || echo "AppImage build failed or had warnings"
          
          # Copy artifacts
          echo "=== Copying artifacts ==="
          find . -name "*.deb" -type f 2>/dev/null
          find . -name "*.AppImage" -type f 2>/dev/null
          find dist -name "*.deb" -exec cp {} artifacts/doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-amd64.deb \; 2>/dev/null || true
          find dist -name "*.AppImage" -exec cp {} artifacts/doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x86_64.AppImage \; 2>/dev/null || true
          
          # List what we have
          echo "=== Final Artifacts ==="
          ls -la artifacts/ || true
          ls -laR dist/ 2>/dev/null || true

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doudou-linux
          path: |
            doudou-*-linux-x64.zip
            artifacts/

  # LINUX - DOCAN
  build-linux-docan:
    if: ${{ github.event.inputs.build_docan == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/docan.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.docan_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.docan_commit_hash }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev dpkg-dev wget file squashfs-tools patchelf plocate libfuse2 libjsoncpp-dev rpm zsync
          # Update locate database
          sudo updatedb || true

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install appimagetool
        run: |
          wget -q -O /tmp/appimagetool.AppImage "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool.AppImage
          cd /tmp && ./appimagetool.AppImage --appimage-extract
          sudo mv /tmp/squashfs-root /opt/appimagetool
          sudo ln -sf /opt/appimagetool/AppRun /usr/local/bin/appimagetool
          # Verify appimagetool works
          appimagetool --version || echo "appimagetool installed"

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build/linux/x64/release
          zip -r $GITHUB_WORKSPACE/docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x64.zip bundle/

      - name: Install fastforge and build packages
        run: |
          dart pub global activate fastforge
          export PATH="$PATH:$HOME/.pub-cache/bin"
          export PUB_CACHE="$HOME/.pub-cache"
          mkdir -p artifacts
          
          # Check for configuration files
          echo "=== Checking configuration files ==="
          ls -la linux/packaging/ || echo "No linux/packaging directory"
          ls -la linux/packaging/deb/ 2>/dev/null || echo "No deb config"
          ls -la linux/packaging/appimage/ 2>/dev/null || echo "No appimage config"
          cat distribute_options.yaml 2>/dev/null || echo "No distribute_options.yaml"
          
          # Build DEB
          echo "=== Building DEB package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets deb --skip-clean || echo "DEB build failed or had warnings"
          
          # Build AppImage
          echo "=== Building AppImage package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets appimage --skip-clean || echo "AppImage build failed or had warnings"
          
          # Copy artifacts
          echo "=== Copying artifacts ==="
          find . -name "*.deb" -type f 2>/dev/null
          find . -name "*.AppImage" -type f 2>/dev/null
          find dist -name "*.deb" -exec cp {} artifacts/docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-amd64.deb \; 2>/dev/null || true
          find dist -name "*.AppImage" -exec cp {} artifacts/docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x86_64.AppImage \; 2>/dev/null || true
          
          # List what we have
          echo "=== Final Artifacts ==="
          ls -la artifacts/ || true
          ls -laR dist/ 2>/dev/null || true

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docan-linux
          path: |
            docan-*-linux-x64.zip
            artifacts/

  # LINUX - FINAR
  build-linux-finar:
    if: ${{ github.event.inputs.build_finar == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/finar.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.finar_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.finar_commit_hash }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libmpv-dev dpkg-dev wget file squashfs-tools patchelf plocate libfuse2
          # Update locate database
          sudo updatedb || true

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install appimagetool
        run: |
          wget -q -O /tmp/appimagetool.AppImage "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool.AppImage
          cd /tmp && ./appimagetool.AppImage --appimage-extract
          sudo mv /tmp/squashfs-root /opt/appimagetool
          sudo ln -sf /opt/appimagetool/AppRun /usr/local/bin/appimagetool
          # Verify appimagetool works
          appimagetool --version || echo "appimagetool installed"

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          flutter build linux --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build/linux/x64/release
          zip -r $GITHUB_WORKSPACE/finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x64.zip bundle/

      - name: Install fastforge and build packages
        run: |
          dart pub global activate fastforge
          export PATH="$PATH:$HOME/.pub-cache/bin"
          export PUB_CACHE="$HOME/.pub-cache"
          mkdir -p artifacts
          
          # Check for configuration files
          echo "=== Checking configuration files ==="
          ls -la linux/packaging/ || echo "No linux/packaging directory"
          ls -la linux/packaging/deb/ 2>/dev/null || echo "No deb config"
          ls -la linux/packaging/appimage/ 2>/dev/null || echo "No appimage config"
          cat distribute_options.yaml 2>/dev/null || echo "No distribute_options.yaml"
          
          # Build DEB
          echo "=== Building DEB package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets deb --skip-clean || echo "DEB build failed or had warnings"
          
          # Build AppImage
          echo "=== Building AppImage package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets appimage --skip-clean || echo "AppImage build failed or had warnings"
          
          # Copy artifacts
          echo "=== Copying artifacts ==="
          find . -name "*.deb" -type f 2>/dev/null
          find . -name "*.AppImage" -type f 2>/dev/null
          find dist -name "*.deb" -exec cp {} artifacts/finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-amd64.deb \; 2>/dev/null || true
          find dist -name "*.AppImage" -exec cp {} artifacts/finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x86_64.AppImage \; 2>/dev/null || true
          
          # List what we have
          echo "=== Final Artifacts ==="
          ls -la artifacts/ || true
          ls -laR dist/ 2>/dev/null || true

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: finar-linux
          path: |
            finar-*-linux-x64.zip
            artifacts/

  # LINUX - KLIT
  build-linux-klit:
    if: ${{ github.event.inputs.build_klit == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/klit.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.klit_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.klit_commit_hash }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libmpv-dev dpkg-dev wget file squashfs-tools patchelf plocate libfuse2
          # Update locate database
          sudo updatedb || true

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install appimagetool
        run: |
          wget -q -O /tmp/appimagetool.AppImage "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool.AppImage
          cd /tmp && ./appimagetool.AppImage --appimage-extract
          sudo mv /tmp/squashfs-root /opt/appimagetool
          sudo ln -sf /opt/appimagetool/AppRun /usr/local/bin/appimagetool
          # Verify appimagetool works
          appimagetool --version || echo "appimagetool installed"

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Linux
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
          flutter build linux --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build/linux/x64/release
          zip -r $GITHUB_WORKSPACE/klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x64.zip bundle/

      - name: Install fastforge and build packages
        run: |
          dart pub global activate fastforge
          export PATH="$PATH:$HOME/.pub-cache/bin"
          export PUB_CACHE="$HOME/.pub-cache"
          mkdir -p artifacts
          
          # Check for configuration files
          echo "=== Checking configuration files ==="
          ls -la linux/packaging/ || echo "No linux/packaging directory"
          ls -la linux/packaging/deb/ 2>/dev/null || echo "No deb config"
          ls -la linux/packaging/appimage/ 2>/dev/null || echo "No appimage config"
          cat distribute_options.yaml 2>/dev/null || echo "No distribute_options.yaml"
          
          # Build DEB
          echo "=== Building DEB package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets deb --skip-clean || echo "DEB build failed or had warnings"
          
          # Build AppImage
          echo "=== Building AppImage package ==="
          $HOME/.pub-cache/bin/fastforge package --platform linux --targets appimage --skip-clean || echo "AppImage build failed or had warnings"
          
          # Copy artifacts
          echo "=== Copying artifacts ==="
          find . -name "*.deb" -type f 2>/dev/null
          find . -name "*.AppImage" -type f 2>/dev/null
          find dist -name "*.deb" -exec cp {} artifacts/klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-amd64.deb \; 2>/dev/null || true
          find dist -name "*.AppImage" -exec cp {} artifacts/klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-linux-x86_64.AppImage \; 2>/dev/null || true
          
          # List what we have
          echo "=== Final Artifacts ==="
          ls -la artifacts/ || true
          ls -laR dist/ 2>/dev/null || true

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: klit-linux
          path: |
            klit-*-linux-x64.zip
            artifacts/

  # ============================================================================
  # WEB BUILDS
  # ============================================================================

  # WEB - DOUDOU
  build-web-doudou:
    if: ${{ github.event.inputs.build_doudou == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/doudou.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.doudou_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.doudou_commit_hash }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Web
        run: |
          flutter pub get
          flutter build web --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build
          zip -r $GITHUB_WORKSPACE/doudou-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-web.zip web/

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: doudou-web
          path: doudou-*-web.zip

  # WEB - DOCAN
  build-web-docan:
    if: ${{ github.event.inputs.build_docan == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/docan.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.docan_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.docan_commit_hash }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Web
        run: |
          flutter pub get
          flutter build web --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build
          zip -r $GITHUB_WORKSPACE/docan-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-web.zip web/

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docan-web
          path: docan-*-web.zip

  # WEB - FINAR
  build-web-finar:
    if: ${{ github.event.inputs.build_finar == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/finar.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.finar_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.finar_commit_hash }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Web
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          flutter build web --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build
          zip -r $GITHUB_WORKSPACE/finar-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-web.zip web/

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finar-web
          path: finar-*-web.zip

  # WEB - KLIT
  build-web-klit:
    if: ${{ github.event.inputs.build_klit == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      duration: ${{ steps.duration.outputs.duration }}
      status: ${{ steps.status.outputs.status }}
    steps:
      - name: Record start time
        id: start
        run: echo "start_time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Clone GitLab Repo
        run: git clone https://gitlab.com/Openlyst/klit.git .

      - name: Checkout specific commit
        if: ${{ github.event.inputs.klit_commit_hash != '' }}
        run: git checkout ${{ github.event.inputs.klit_commit_hash }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          BUILD_DATE=$(date +%Y-%m-%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build Web
        run: |
          flutter pub get
          flutter build web --release --build-name=${{ steps.version.outputs.version }}

      - name: Create ZIP
        run: |
          cd build
          zip -r $GITHUB_WORKSPACE/klit-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_date }}-web.zip web/

      - name: Record duration and status
        id: duration
        if: always()
        run: |
          start_time="${{ steps.start.outputs.start_time }}"
          start_seconds=$(date -d "$start_time" +%s)
          end_seconds=$(date +%s)
          duration=$(echo "scale=1; ($end_seconds - $start_seconds) / 60" | bc)
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Set status
        id: status
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: klit-web
          path: klit-*-web.zip

  # ============================================================================
  # CREATE GITHUB RELEASE
  # ============================================================================
  create-release:
    needs: 
      - build-windows-doudou
      - build-windows-docan
      - build-windows-finar
      - build-windows-klit
      - build-android-doudou
      - build-android-docan
      - build-android-finar
      - build-android-klit
      - build-linux-doudou
      - build-linux-docan
      - build-linux-finar
      - build-linux-klit
      - build-web-doudou
      - build-web-docan
      - build-web-finar
      - build-web-klit
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Generate build report
        id: report
        run: |
          BUILD_DATE=$(date +%Y-%m-%d)
          BUILD_TIME=$(date +%H:%M:%S)
          
          # Count artifacts
          APK_COUNT=$(find . -name "*.apk" 2>/dev/null | wc -l)
          AAB_COUNT=$(find . -name "*.aab" 2>/dev/null | wc -l)
          ZIP_COUNT=$(find . -name "*.zip" 2>/dev/null | wc -l)
          DEB_COUNT=$(find . -name "*.deb" 2>/dev/null | wc -l)
          APPIMAGE_COUNT=$(find . -name "*.AppImage" 2>/dev/null | wc -l)
          TOTAL_COUNT=$((APK_COUNT + AAB_COUNT + ZIP_COUNT + DEB_COUNT + APPIMAGE_COUNT))
          
          # List all artifacts with sizes
          echo "## 📦 Build Artifacts" > release_notes.md
          echo "" >> release_notes.md
          echo "| File | Size |" >> release_notes.md
          echo "|------|------|" >> release_notes.md
          find . -type f \( -name "*.zip" -o -name "*.apk" -o -name "*.aab" -o -name "*.deb" -o -name "*.AppImage" \) -exec sh -c 'echo "| $(basename {}) | $(du -h {} | cut -f1) |"' \; >> release_notes.md
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          
          # Build summary
          echo "## 📊 Build Summary" >> release_notes.md
          echo "" >> release_notes.md
          echo "| Metric | Value |" >> release_notes.md
          echo "|--------|-------|" >> release_notes.md
          echo "| 📅 Build Date | $BUILD_DATE |" >> release_notes.md
          echo "| ⏰ Build Time | $BUILD_TIME UTC |" >> release_notes.md
          echo "| 📱 APKs | $APK_COUNT |" >> release_notes.md
          echo "| 📦 AABs | $AAB_COUNT |" >> release_notes.md
          echo "| 🗜️ ZIPs | $ZIP_COUNT |" >> release_notes.md
          echo "| 🐧 DEBs | $DEB_COUNT |" >> release_notes.md
          echo "| 🖼️ AppImages | $APPIMAGE_COUNT |" >> release_notes.md
          echo "| **Total Artifacts** | **$TOTAL_COUNT** |" >> release_notes.md
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          
          # Project status section
          echo "## 🏗️ Build Status by Project" >> release_notes.md
          echo "" >> release_notes.md
          
          # Doudou
          if [ "${{ github.event.inputs.build_doudou }}" == "true" ]; then
            echo "### Doudou" >> release_notes.md
            echo "- Version: ${{ needs.build-android-doudou.outputs.version || needs.build-windows-doudou.outputs.version || 'N/A' }}" >> release_notes.md
            echo "- Windows: ${{ needs.build-windows-doudou.outputs.status || 'skipped' }} ${{ needs.build-windows-doudou.outputs.duration && format('({0} min)', needs.build-windows-doudou.outputs.duration) || '' }}" >> release_notes.md
            echo "- Android: ${{ needs.build-android-doudou.outputs.status || 'skipped' }} ${{ needs.build-android-doudou.outputs.duration && format('({0} min)', needs.build-android-doudou.outputs.duration) || '' }} - Signing: ${{ needs.build-android-doudou.outputs.signing || 'N/A' }}" >> release_notes.md
            echo "- Linux: ${{ needs.build-linux-doudou.outputs.status || 'skipped' }} ${{ needs.build-linux-doudou.outputs.duration && format('({0} min)', needs.build-linux-doudou.outputs.duration) || '' }}" >> release_notes.md
            echo "- Web: ${{ needs.build-web-doudou.outputs.status || 'skipped' }} ${{ needs.build-web-doudou.outputs.duration && format('({0} min)', needs.build-web-doudou.outputs.duration) || '' }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Docan
          if [ "${{ github.event.inputs.build_docan }}" == "true" ]; then
            echo "### Docan" >> release_notes.md
            echo "- Version: ${{ needs.build-android-docan.outputs.version || needs.build-windows-docan.outputs.version || 'N/A' }}" >> release_notes.md
            echo "- Windows: ${{ needs.build-windows-docan.outputs.status || 'skipped' }} ${{ needs.build-windows-docan.outputs.duration && format('({0} min)', needs.build-windows-docan.outputs.duration) || '' }}" >> release_notes.md
            echo "- Android: ${{ needs.build-android-docan.outputs.status || 'skipped' }} ${{ needs.build-android-docan.outputs.duration && format('({0} min)', needs.build-android-docan.outputs.duration) || '' }} - Signing: ${{ needs.build-android-docan.outputs.signing || 'N/A' }}" >> release_notes.md
            echo "- Linux: ${{ needs.build-linux-docan.outputs.status || 'skipped' }} ${{ needs.build-linux-docan.outputs.duration && format('({0} min)', needs.build-linux-docan.outputs.duration) || '' }}" >> release_notes.md
            echo "- Web: ${{ needs.build-web-docan.outputs.status || 'skipped' }} ${{ needs.build-web-docan.outputs.duration && format('({0} min)', needs.build-web-docan.outputs.duration) || '' }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Finar
          if [ "${{ github.event.inputs.build_finar }}" == "true" ]; then
            echo "### Finar" >> release_notes.md
            echo "- Version: ${{ needs.build-android-finar.outputs.version || needs.build-windows-finar.outputs.version || 'N/A' }}" >> release_notes.md
            echo "- Windows: ${{ needs.build-windows-finar.outputs.status || 'skipped' }} ${{ needs.build-windows-finar.outputs.duration && format('({0} min)', needs.build-windows-finar.outputs.duration) || '' }}" >> release_notes.md
            echo "- Android: ${{ needs.build-android-finar.outputs.status || 'skipped' }} ${{ needs.build-android-finar.outputs.duration && format('({0} min)', needs.build-android-finar.outputs.duration) || '' }} - Signing: ${{ needs.build-android-finar.outputs.signing || 'N/A' }}" >> release_notes.md
            echo "- Linux: ${{ needs.build-linux-finar.outputs.status || 'skipped' }} ${{ needs.build-linux-finar.outputs.duration && format('({0} min)', needs.build-linux-finar.outputs.duration) || '' }}" >> release_notes.md
            echo "- Web: ${{ needs.build-web-finar.outputs.status || 'skipped' }} ${{ needs.build-web-finar.outputs.duration && format('({0} min)', needs.build-web-finar.outputs.duration) || '' }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Klit
          if [ "${{ github.event.inputs.build_klit }}" == "true" ]; then
            echo "### Klit" >> release_notes.md
            echo "- Version: ${{ needs.build-android-klit.outputs.version || needs.build-windows-klit.outputs.version || 'N/A' }}" >> release_notes.md
            echo "- Windows: ${{ needs.build-windows-klit.outputs.status || 'skipped' }} ${{ needs.build-windows-klit.outputs.duration && format('({0} min)', needs.build-windows-klit.outputs.duration) || '' }}" >> release_notes.md
            echo "- Android: ${{ needs.build-android-klit.outputs.status || 'skipped' }} ${{ needs.build-android-klit.outputs.duration && format('({0} min)', needs.build-android-klit.outputs.duration) || '' }} - Signing: ${{ needs.build-android-klit.outputs.signing || 'N/A' }}" >> release_notes.md
            echo "- Linux: ${{ needs.build-linux-klit.outputs.status || 'skipped' }} ${{ needs.build-linux-klit.outputs.duration && format('({0} min)', needs.build-linux-klit.outputs.duration) || '' }}" >> release_notes.md
            echo "- Web: ${{ needs.build-web-klit.outputs.status || 'skipped' }} ${{ needs.build-web-klit.outputs.duration && format('({0} min)', needs.build-web-klit.outputs.duration) || '' }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          
          # Warnings section
          echo "## ⚠️ Notes & Warnings" >> release_notes.md
          echo "" >> release_notes.md
          
          # Check for failed builds
          FAILED_BUILDS=""
          if [ "${{ needs.build-windows-doudou.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Doudou-Windows"; fi
          if [ "${{ needs.build-windows-docan.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Docan-Windows"; fi
          if [ "${{ needs.build-windows-finar.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Finar-Windows"; fi
          if [ "${{ needs.build-windows-klit.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Klit-Windows"; fi
          if [ "${{ needs.build-android-doudou.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Doudou-Android"; fi
          if [ "${{ needs.build-android-docan.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Docan-Android"; fi
          if [ "${{ needs.build-android-finar.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Finar-Android"; fi
          if [ "${{ needs.build-android-klit.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Klit-Android"; fi
          if [ "${{ needs.build-linux-doudou.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Doudou-Linux"; fi
          if [ "${{ needs.build-linux-docan.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Docan-Linux"; fi
          if [ "${{ needs.build-linux-finar.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Finar-Linux"; fi
          if [ "${{ needs.build-linux-klit.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Klit-Linux"; fi
          if [ "${{ needs.build-web-doudou.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Doudou-Web"; fi
          if [ "${{ needs.build-web-docan.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Docan-Web"; fi
          if [ "${{ needs.build-web-finar.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Finar-Web"; fi
          if [ "${{ needs.build-web-klit.outputs.status }}" == "failure" ]; then FAILED_BUILDS="$FAILED_BUILDS Klit-Web"; fi
          
          if [ -n "$FAILED_BUILDS" ]; then
            echo "🔴 **Failed builds:**$FAILED_BUILDS" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Check for debug signing
          DEBUG_SIGNED=""
          if [ "${{ needs.build-android-doudou.outputs.signing }}" == "debug" ]; then DEBUG_SIGNED="$DEBUG_SIGNED Doudou"; fi
          if [ "${{ needs.build-android-docan.outputs.signing }}" == "debug" ]; then DEBUG_SIGNED="$DEBUG_SIGNED Docan"; fi
          if [ "${{ needs.build-android-finar.outputs.signing }}" == "debug" ]; then DEBUG_SIGNED="$DEBUG_SIGNED Finar"; fi
          if [ "${{ needs.build-android-klit.outputs.signing }}" == "debug" ]; then DEBUG_SIGNED="$DEBUG_SIGNED Klit"; fi
          
          if [ -n "$DEBUG_SIGNED" ]; then
            echo "🟡 **Debug signed (missing keystore):**$DEBUG_SIGNED" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -z "$FAILED_BUILDS" ] && [ -z "$DEBUG_SIGNED" ]; then
            echo "✅ All requested builds completed successfully with release signing!" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## 📋 Platform Information" >> release_notes.md
          echo "" >> release_notes.md
          echo "| Platform | Formats | Architecture |" >> release_notes.md
          echo "|----------|---------|--------------|" >> release_notes.md
          echo "| Windows | ZIP | x64 |" >> release_notes.md
          echo "| Android | APK, AAB | arm64-v8a, armeabi-v7a, x86_64 |" >> release_notes.md
          echo "| Linux | ZIP, DEB, AppImage | x86_64 |" >> release_notes.md
          echo "| Web | ZIP | Universal |" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "*Built with Flutter stable channel on GitHub Actions*" >> release_notes.md
          echo "*Run #${{ github.run_number }} - Triggered by @${{ github.actor }}*" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "Build #${{ github.run_number }} - $(date +%Y-%m-%d)"
          body_path: release_notes.md
          files: |
            *.zip
            *.apk
            *.aab
            *.deb
            *.AppImage
